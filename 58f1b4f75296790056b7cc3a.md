# 全市场PBPE估值 2.0

一年前写过全市场PBPE估值，它是根据全市场股票PE和PB的中位数来估值。

20171124增加内容：
1. 根据深综指日K线对数坐标直线拟合估值。
2. PE，PB和深综指时间域综合估值。
3. 根据PB估值按照齐东平的大数投资法则给出综合仓位。
4. 修改几个小bug

20180206更新如下：
1.增加沪深300，中证500，中证1000的估值。
2.晚上十点以后数据是当天的数据，十点以前数据是昨天的。

20180401更新如下：
增加一张图，把全部A股，沪深300，中证500，中证1000的估值放在一张图以显示全市场情况。横轴是绝对数值，纵轴是百分位，圆的大小代表市值。

20180408更新如下：
清明在家几乎重写了代码
1.增加了申万行业指数。
2.增加了加权指数估值
3.全市场估值改为箱线图。
4.修正了中证1000数据不全的问题。
5.因为指数很多，如果全部显示详细指数历史估值，图表结果会很长，不美观方便。所以在源代码指数列表里加了开关。
在下面指数列表的最后一列如果是'on',会显示详细历史估值；如果是'off'，不会显示详细历史估值。
myset=[
       ['A',u'沪深A股',"399106",u'深证综指','on'],
       ['000300.ZICN',u'沪深300','000300',u'沪深300','off'],
       ['399314.ZICN',u'巨潮大盘','399314',u'巨潮大盘','off'],
       ['000905.ZICN',u'中证500','000905',u'中证500','off'],
       ['399315.ZICN',u'巨潮中盘','399315',u'巨潮中盘','off'],
       ['000852.ZICN',u'中证1000','000852',u'中证1000','off'],
       ['399316.ZICN',u'申万.巨潮小盘','399316',u'申万.巨潮小盘','off'],
       ['801010.ZICN',u'申万.农林牧渔','801010',u'申万.农林牧渔','off'],
       ['801020.ZICN',u'申万.采掘','801020',u'申万.采掘','off'],
       ['801030.ZICN',u'申万.化工','801030',u'申万.化工','off'],
       ['801040.ZICN',u'申万.钢铁','801040',u'申万.钢铁','off'],
       ['801050.ZICN',u'申万.有色金属','801050',u'申万.有色金属','off'],
       ['801080.ZICN',u'申万.电子','801080',u'申万.电子','off'],
       ['801110.ZICN',u'申万.家用电器','801110',u'申万.家用电器','off'],
       ['801120.ZICN',u'申万.食品饮料','801120',u'申万.食品饮料','off'],
       ['801130.ZICN',u'申万.纺织服装','801130',u'申万.纺织服装','off'],
       ['801140.ZICN',u'申万.轻工制造','801140',u'申万.轻工制造','off'],
       ['801150.ZICN',u'申万.医药生物','801150',u'申万.医药生物','on'],
      ]
      
20180411更新如下：
1.周期行业PE和PE*PB估值没有意义。所以为了统一和简化，只保留了PB估值。一般情况下中位数PB估值准确些，但是我是ETF投资者，而ETF基本都是加权ETF，所以还是保留了加权PB。综合估值以中位数PB为主，时间估值和加权PB辅助的方式：2份中位数PB，一份加权PB，一份时间估值。
2.增加了全市场综合估值和仓位图，把个行业综合估值和仓位放到了一张图里。一帮情况下只看最后一张图就行了。

20180415更新如下：
1.在K线图上叠加了换手率。
2.数据做去极值处理。

20180504更新如下：
1. 在全A的k线图上增加了基于28个申万行业的趋势度。

20180505更新如下：
1. 增加一个月前的估值，作为对比。

20180526更新如下：
1. 增加上证50
2. 全市场估值增加两张非常有趣有用的图，不解释，懂得自然懂。

20180701更新：
增加低于当前PB时间(月)。这个有什么用呢？可以大约判断熊市还能跌多长时间到底。因为数据只包含了两轮熊市，所以这个时间除以4就是未来还会跌的时间长度。

20180730更新如下：
做了一些小的完善，简化。
1. 增加关于定投的信息。低于20%时开始定投，估值20%时，定投比例100%；估值10%时，定投比例200%；估值0时，定投比例400%。
2. 之前的仓位按照齐东平的2p-1太过激进，现在增加保守点的仓位配置(2P-1)/2。基本上左侧交易者可以按照激进仓位配置，右侧交易者可以按照保守仓位配置。

3. 在时域K线图中，增加一条粗红颜色的线，这条线基本对应估值20-30%，低于此线就可以开始定投了。

20180807更新如下：
在全市场估值中增加巴菲特指标。修正GDP数值更准确些：最新GDP数值采用最近四个季度GDP。

20181005更新如下：
1. 最后的全部市场单一的PB估值图，变为PE，PB估值图。
2. 百分位估值有一个缺陷。百分位估值有效的前提是均值回归。但是均值回归的真实意义是价格回归价值，而不是估值回归中位数。虽然大多数情况下这两者是相同的，但是少数价值毁灭股票却会落入陷阱。比如银行估值一直在震荡走低，现在看不到，未来不知道什么时候才能回归中位数。现在的小盘股也可能面临这种情况，随着注册制预期或者估值与国际接轨，小盘股的估值走势也可能和银行一样。避免这个缺陷的方法是看绝对估值或者绝对收益率，最好把绝对估值和相对估值结合起来看。
增加的绝对估值如下，增加加权PE，和**当前买入预期年化收益率**。下面两个指数300和500，虽然500相对估值低，但是从绝对估值看300更值得买。年化收益300比500多3个百分点。

沪深300 综合估值百分位（PB，时间）:14%(上月:11%)
当前加权PE:11.6(上月:11.1)
当前买入预期年化收益率（不考虑估值变化）:11.5%(上月:11.6%)

中证500 综合估值百分位（PB，时间）:1%(上月:1%)
当前加权PE:19.7(上月:20.0)
当前买入预期年化收益率（不考虑估值变化）:8.2%(上月:8.1%)

20181228更新如下：
**增加存量数据自动保存，增量数据自动更新功能。第一次运行时间会很长，以后更新如下再次运行时间会非常短。**
感谢@JasperChou。

20190210更新如下：
优化沪深A股PE，PB分布图和巴菲特指标。

20200205 春节禁足在家继续打磨这个小程序：
1. 删除了巴菲特指标。优矿没有提供GDP数据，我是人工把GDP写到程序里，所以GDP数据不能自动更新，随着时间，误差会越来越大。先把巴菲特指标删除，等以后优矿有历史GDP数据后再把巴菲特指标加上去。
2. 增加了10年国债收益率和中位数市盈率收益率的图表。把全体市场和10年国债比较来看是便宜还是贵。优矿提供的国债数据不长，只有最近两年的。所以我人工做了历史国债收益率文件。程序会把历史数据和优矿提供的最新数据合并处理。国债收益率历史文件我放在百度网盘，下载下来放在数据里就可以了。如果没有这个文件也不影响程序的运行，只是少了一张国债收益率和市盈率收益率的图片。
链接: https://pan.baidu.com/s/1QxTD45XUUqv9XmnWipGChw 提取码: 71kg

20200207 更新如下：
用中证500的收盘数据生成07年牛市，09-10年牛市，15年牛市和最近牛市（我假定现在已经进入牛市），这四个牛市的数据。把这四个牛市的数据放在一张图片里比较，起步时间和点位对齐，看看这次牛市未来还有多大的空间和时间。这张图片放在中证500估值图片后面。

20200218更新如下：
百分位估值的数据范围从全部历史数据改为用最近七年历史数据。

20201220更新如下：
增加大盘小盘和价值成长图片和细节优化，

20210316
增加一个择时抄底指标。算法是波动率/换手率。放在K线图中用点状绿线表示。如果这个指标很高，就代表可以抄底了。

20210418
细节优化

20211101更新如下：
增加可转债市场估值。用全体转债价格中位数，全体转债转股溢价率中位数，全体转债纯债溢价率中位数来对转债市场进行估值。

20220122更新如下：
1. 增加恒生指数估值
2. 增加市场行业动量指标

20220216更新如下：
1. 增加技术分析指标

20220426 优化

注：下面链接是集思录的估值，我的估值结果基本和集思录的估值结果基本一致。
https://www.jisilu.cn/data/indicator/

  换手率图线非常有价值，就是人气指标，反应市场热度，而且往往是“量在价先”。我的算法copy的value500市场人气指标，当然结果也是一样的。
  http://value500.com/volv500.html
  