# 根据交易记录画出账户市值的每天走势 

根据mv=sum（每个股持仓数量*每个股价格）我们可以根据持仓算出组合的市值的时间序列（这里不包括账户现金）。持仓可以是持股数量，也可以是权重。

但是这种方法是静态的，适合持股不动的情况，对动态的情况，发生频繁买卖的，会在市值曲线上产生巨大的缺口Gap，比如今天买入大量的万科，那么市值曲线就会突然跳高。而且由于万科是你最近追涨买入的，所以市值曲线的走势会明显好于你之前的市值曲线（这对今天往后的交易有帮助，但是不反映你过去真实的交易盈亏）。

有些券商可以提供每日账户市值的时间序列，这样后一日减去前一日，就可以得到每天的盈亏，再把它累加起来，就可以得到消除Gap的市值曲线（也叫累计盈亏曲线，也等价于调整起点后的市值曲线）。但是这种方法也有明显的局限性，就是只能计算账户总体的，而且大多数券商还不提供这些日终市值数据，所以我们需要对上述这种用持仓来计算市值的方法做调整。 下面用python实现。这种方法的强大之处在于你只要输入少量的,稀疏的交易记录(按时间排序),算法就能还原完整的持仓的时间序列全貌,从而画出每天的市值走势.  比如一个股票你是10块买的，涨到20你没抛，最后跌到11块你抛了，那么realized gain就是11-10=1块，而涨到20的那些日子，浮盈unrealized gain你是没有记录在案的。本篇中的方法，就是要把这些浮盈也记录下来。

            
比如持股数量的向量如下：
   万科 ,  中国平安
A=(100 ,   400)     股

价格时间序列矩阵如下：
B = (2017-10-11, 6.54, 16.5
     2017-10-12, 7.54, 17.5
     2017-10-13, 8.54, 18.5, ... etc. )

我们用C=B*trans(A)可以得到组合每天的市值。

上面是静态的，没有发生交易的情况，对之后发生交易的，持股向量A会发生变化，比如某天再买入万科后，变成A=(1500, 400) ，所以算出来的C会在交易日那天产生巨大的缺口Gap。幸运的是，我们可以把上面的情况推广到一般情况。如下，我们让A变成交易记录矩阵，而不再是持股向量：
A=(
2017-09-01, 万科，      100；
2017-09-02, 中国平安，  200；
2017-09-03, 万科，      100；
2017-09-04, 万科，     -100）

然后对A做pivot table，左列是date，头列head column是股票代码，value是sum(交易数量)
得到A2，
          万科 , 中国平安
A2=（
2017-09-01, 100，NA
2017-09-02, NA ，200
2017-09-03, 100，NA
2017-09-04, -100，NA）

再把A2.fillna(0) , 也即把NA填充成0，得到A3，再把A3. cumsum() ,得到持仓的时间序列矩阵A4
           万科 , 中国平安
A4=（
2017-09-01, 100，0
2017-09-02, 100，200
2017-09-03, 200，200
2017-09-04, 100，200）

我们再把A4 right join 价格矩阵B的date列，把缺少的日期填满，得到A5，对A5.fillna(method='ffill') 也即向前fill na，
再把A5 点乘 价格矩阵B， 就可以得到市值的时间序列C2， 我们用C2的每一行的sum减去上一行的sum就得到组合的盈亏增量的时间序列向量C3， 但是这时候由于发生买卖的交易，C3还没有消除Gap，我们需要在发生交易的这个日子做调整，原理如下：

对于当日买入：万科的数量由昨天的a增加到今天的b，假设（b-a）的数量是在收盘前才买入，所以（b-a）的部分不产生盈亏，只有a的部分产生盈亏=a*(P2-P1)，那么C2中算出的当天的盈亏要做调整，C2=C2 -（b-a）*P2（P2是当天收盘价）
对卖出也是一样，a-&gt;b, (b小于a），（a-b）的部分不计入盈亏，所以C2中算出的当天的盈亏要+（a-b）*P, 和上面的公式是一致的。

所以结果就是对A5，用每一行减去上一行，再点乘价格矩阵B，得到的结果加到C3上去。注意不是加到C2上去，不然会影响下一日盈亏增量的计算。

结果C3里面不仅包括了总体股票市值的走势，还包含具体每个股的市值走势。

代码我还没来的及编写。
