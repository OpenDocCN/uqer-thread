# 随机森林策略

随机森林
相关概念
分类器：分类器就是给定一个样本的数据，判定这个样本属于哪个类别的算法。例如在股票
涨跌预测中，我们认为前一天的交易量和收盘价对于第二天的涨跌是有影响的，那么分类器
就是通过样本的交易量和收盘价预测第二天的涨跌情况的算法。
分裂 ：在决策树的训练过程中，需要一次次的将训练数据集分裂成两个子数据集，这个过程
就叫做分裂。
特征 ：在分类问题中，输入到分类器中的数据叫做特征。以上面的股票涨跌预测问题为例，
特征就是前一天的交易量和收盘价。
待 选 特征 ：在决策树的构建过程中，需要按照一定的次序从全部的特征中选取特征。待选特
征就是在目前的步骤之前还没有被选择的特征的集合。例如，全部的特征是 ABCDE，第一
步的时候，待选特征就是 ABCDE，第一步选择了 C，那么第二步的时候，待选特征就是
ABDE。
分裂 特征 ：接待选特征的定义，每一次选取的特征就是分裂特征，例如，在上面的例子中，
第一步的分裂特征就是 C。因为选出的这些特征将数据集分成了一个个不相交的部分，所以
叫它们分裂特征。
1. 决策树的构建过程
要说随机森林，必须先讲决策树。决策树是一种基本的分类器，一般是将特征分为两类（决
策树也可以用来回归，不过本文中暂且不表）。构建好的决策树呈树形结构，可以认为是
if-then 规则的集合，主要优点是模型具有可读性，分类速度快。
我们用选择量化工具的过程形象的展示一下决策树的构建。假设现在要选择一个优秀的量化
工具来帮助我们更好的炒股，怎么选呢？
第一步：看看工具提供的数据是不是非常全面，数据不全面就不用。
第二步：看看工具提供的 API 是不是好用，API 不好用就不用。
第三步：看看工具的回测过程是不是靠谱，不靠谱的回测出来的策略也不敢用啊。
第四步：看看工具支不支持模拟交易，光回测只是能让你判断策略在历史上有用没有，正式
运行前起码需要一个模拟盘吧。
这样，通过将“数据是否全面”，“API 是否易用”，“回测是否靠谱”，“是否支持模拟
交易”将市场上的量化工具贴上两个标签，“使用”和“不使用”。
可以看到，决策树的主要工作，就是选取特征对数据集进行划分，最后把数据贴上两类不同
的标签。如何选取最好的特征呢？还用上面选择量化工具的例子：假设现在市场上有 100
个量化工具作为训练数据集，这些量化工具已经被贴上了“可用”和“不可用”的标签。
我们首先尝试通过“API 是否易用”将数据集分为两类；发现有 90 个量化工具的 API 是好
用的，10 个量化工具的 API 是不好用的。而这 90 个量化工具中，被贴上“可以使用”标
签的占了 40 个，“不可以使用”标签的占了 50 个，那么，通过“API 是否易用”对于数
据的分类效果并不是特别好。因为，给你一个新的量化工具，即使它的 API 是易用的，你
还是不能很好贴上“使用”的标签。
2. 随机森林的构建过程
决策树相当于一个大师，通过自己在数据集中学到的知识对于新的数据进行分类。但是俗话
说得好，一个诸葛亮，玩不过三个臭皮匠。随机森林就是希望构建多个臭皮匠，希望最终的
分类效果能够超过单个大师的一种算法。
那随机森林具体如何构建呢？有两个方面：数据的随机性选取，以及待选特征的随机选取。
数据的随机选取：
首先，从原始的数据集中采取有放回的抽样，构造子数据集，子数据集的数据量是和原始数
据集相同的。不同子数据集的元素可以重复，同一个子数据集中的元素也可以重复。第二，
利用子数据集来构建子决策树，将这个数据放到每个子决策树中，每个子决策树输出一个结
果。最后，如果有了新的数据需要通过随机森林得到分类结果，就可以通过对子决策树的判
断结果的投票，得到随机森林的输出结果了。如下图，假设随机森林中有 3 棵子决策树，2
棵子树的分类结果是 A 类，1 棵子树的分类结果是 B 类，那么随机森林的分类结果就是 A
类。
待选特征的随机选取：
与数据集的随机选取类似，随机森林中的子树的每一个分裂过程并未用到所有的待选特征，
而是从所有的待选特征中随机选取一定的特征，之后再在随机选取的特征中选取最优的特征。
这样能够使得随机森林中的决策树都能够彼此不同，提升系统的多样性，从而提升分类性能。
下图中，蓝色的方块代表所有可以被选择的特征，也就是目前的待选特征。黄色的方块是分
裂特征。左边是一棵决策树的特征选取过程，通过在待选特征中选取最优的分裂特征（别忘
了前文提到的 ID3 算法，C4.5 算法，CART 算法等等），完成分裂。右边是一个随机森林
中的子树的特征选取过程。
3. Random Forrest 的具体使用-sklearn
以上介绍了随机森林的工作原理，那么在 python 环境下，我们可以利用 python 环境下的
sklearn 包来帮助我们完成任务。举个小例子：
特征是通过收盘价数据计算的 SMA，WMA，MOM 指标，训练样本的特征是从 2007-1-4
到 2016-6-2 中截止前一天的 SMA，WMA，MOM 指标，训练样本的标类别是 2007-1-4 日
到 2016-6-2 中每一天的涨跌情况，涨了就是 True，跌了就是 False，测试样本是 2016-6-3
日的三个指标以及涨跌情况。我们可以判定之后判断结果是正确还是错误，如果通过
Random Forest 判断的结果和当天的涨跌情况相符，则输出 True，如果判断结果和当天的
涨跌情况不符，则输出 False。
